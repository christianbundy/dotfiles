#!/usr/bin/env node

const path = require("path");
const fs = require("fs");

const gitallow = path.join(process.cwd(), ".gitallow");
const gitignore = path.join(process.cwd(), ".gitignore");

const notEmpty = (x) => x.length > 0;

const allowList = fs
  .readFileSync(gitallow, "utf8")
  .split("\n")
  .filter(notEmpty);

if (allowList.length === 0) {
  console.log("Usage: gitallow <...path>");
  console.log("Example: gitallow .local/bin .zshrc .vimrc");
  process.exit(1);
}

const output = [
  "# Warning: File is generated from .gitallow, do not edit.",
  "# <https://github.com/christianbundy/dotfiles/blob/master/.local/bin/gitallow>",
  ...allowList
    .sort()
    .map((pathString) => ["/", ...pathString.split(path.sep).filter(notEmpty)])
    .reduce(
      (lines, pathParts) => {
        pathParts.reduce((acc, cur, index) => {
          if (index > 0) {
            lines.push(`!${path.join(...acc, cur)}`);
            if (index < pathParts.length - 1) {
              lines.push(path.join(...acc, cur, "*"));
            }
          }
          return [...acc, cur];
        });

        return lines;
      },
      ["/*"]
    )
    .filter((item, index, array) => array.indexOf(item) === index),
].join("\n");

fs.writeFileSync(gitignore, output);
