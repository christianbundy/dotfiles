#!/usr/bin/env node

const path = require("path");
const fs = require("fs");

const gitallow = path.join(process.cwd(), ".gitallow");
const gitignore = path.join(process.cwd(), ".gitignore");

const notEmpty = (x) => x.length > 0;
const unique = (item, index, array) => array.indexOf(item) === index;

const allowList = fs
  .readFileSync(gitallow, "utf8")
  .split("\n")
  .filter(notEmpty);

// I don't think this changes on other operating systems.
const sep = "/";
const ignoreAll = `${sep}*`;

const output = [
  "# Warning: File is generated from .gitallow, do not edit.",
  "# <https://github.com/christianbundy/dotfiles/blob/master/.local/bin/gitallow>",
  ignoreAll,
  ...allowList
    .sort()
    .map((pathString) => [...pathString.split(sep).filter(notEmpty)])
    .reduce((lines, pathParts) => {
      const allow = (s) => lines.push(["!", ...s].join("/"));
      const deny = (s) => lines.push(["", ...s, "*"].join("/"));

      pathParts.reduce((acc, cur, index) => {
        const currentPathParts = [...acc, cur];
        allow(currentPathParts);
        if (index < pathParts.length - 1) {
          deny(currentPathParts);
        }
        return [...acc, cur];
      }, []);

      return lines;
    }, [])
    .filter(unique),
].join("\n");

fs.writeFileSync(gitignore, output);
